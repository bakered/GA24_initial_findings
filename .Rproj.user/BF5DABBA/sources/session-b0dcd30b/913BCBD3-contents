---
title: "other"
format: html
editor: visual
---

# simple shiny

```{r}
#| panel: sidebar

numericInput("n", "Sample count", 100)
checkboxInput("pause", "Pause", FALSE)
```

```{r}
#| panel: fill
runshiny = TRUE

if(runshiny){
plotOutput('plot')
}
```

```{r}
#| context: server
runshiny = TRUE

if(runshiny){
  
library(shiny)
library(bslib)

data <- reactive({
    input$resample
    if (!isTRUE(input$pause)) {
      invalidateLater(1000)
    }
    rnorm(input$n)
  })
  
output$plot <- renderPlot({
    hist(data(),
      breaks = 40,
      xlim = c(-2, 2),
      ylim = c(0, 1),
      lty = "blank",
      xlab = "value",
      freq = FALSE,
      main = ""
    )
    
    x <- seq(from = -2, to = 2, length.out = 500)
    y <- dnorm(x)
    lines(x, y, lwd=1.5)
    
    lwd <- 5
    abline(v=0, col="red", lwd=lwd, lty=2)
    abline(v=mean(data()), col="blue", lwd=lwd, lty=1)

    legend(legend = c("Normal", "Mean", "Sample mean"),
      col = c("black", "red", "blue"),
      lty = c(1, 2, 1),
      lwd = c(1, lwd, lwd),
      x = 1,
      y = 0.9
    )
  }, res=140)
}
```

# my shiny r app

```{shinylive-r}
#| standalone: true
#| viewerHeight: 800
library(shiny)
library(shinyWidgets)
library(forcats)
library(dplyr)
library(ggplot2)
library(stringr)
library(htmlwidgets)
library(webshot)
library(purrr)

countries <- c("UN", "UN",
               "CN", "SG", "MY", "BN", "JP", "AU", "US", "CA", "IR", "OM", 
               "BD", "PG", "VN", "KR", "TW", "HK", "ID", "ZA", "SN", "PH", "RU", 
               "EG", "IL", "TR", "RO", "IT", "MC", "GR", "BG", "IN", "LK", "MT", 
               "SA", "NL", "BE", "TH", "FR", "DE", "KH", "MM", "KW", "IQ", "KI", 
               "MH", "MX", "AE", "BJ", "GH", "DJ", "MZ", "SC", "GN", "SB", "GY", 
               "BB", "LC", "ES", "CH", "AO", "YE", "GE", "UA", "MU", "GW", "AS", 
               "PL", "IS", "NO", "MA", "TG", "NG", "SE", "DK", "GB", "GA", "SO", 
               "CM", "TT", "BS", "HR", "FI", "PA", "EC", "AR", "VE", "VC", "SR", 
               "GD", "KN", "TC", "AG", "HT", "ME", "AT", "HU", "SK", "ST", "VG", 
               "DO", "BZ", "PT", "HN", "CO", "CR", "BR", "NI", "AL", "EE", "SD", 
               "LB", "JO", "LY", "CY", "QA", "CL", "LV", "LT", "SY", "MD", "CI", 
               "TN", "DZ", "FO", "GL", "UY", "IE", "KM", "TZ", "LR", "CV", "BH", 
               "TM", "AZ", "KZ", "SI", "GI", "PY", "KY", "CU", "JM", "KP", "MR", 
               "GQ", "KE", "RS", "PK", "MS", "MV", "GU", "CG", "GM", "FK", "EH", 
               "SL", "MG", "AW", "PE", "PF", "NZ", "DM", "BM", "ER", "SV", "CD", 
               "MO", "WS", "FJ", "TO", "FM", "TL", "NC", "TV", "GT", "VU", "NR", 
               "MP", "PW", "NU", "CK", "SH", "WF") %>% tolower()
countries2 <- c("UNSG", "UNPGA",
                "CHN", "SGP", "MYS", "BRN", "JPN", "AUS", "USA", "CAN", "IRN", 
                "OMN", "BGD", "PNG", "VNM", "KOR", "TWN", "HKG", "IDN", "ZAF", 
                "SEN", "PHL", "RUS", "EGY", "ISR", "TUR", "ROU", "ITA", "MCO", 
                "GRC", "BGR", "IND", "LKA", "MLT", "SAU", "NLD", "BEL", "THA", 
                "FRA", "DEU", "KHM", "MMR", "KWT", "IRQ", "KIR", "MHL", "MEX", 
                "ARE", "BEN", "GHA", "DJI", "MOZ", "SYC", "GIN", "SLB", "GUY", 
                "BRB", "LCA", "ESP", "CHE", "AGO", "YEM", "GEO", "UKR", "MUS", 
                "GNB", "ASM", "POL", "ISL", "NOR", "MAR", "TGO", "NGA", "SWE", 
                "DNK", "GBR", "GAB", "SOM", "CMR", "TTO", "BHS", "HRV", "FIN", 
                "PAN", "ECU", "ARG", "VEN", "VCT", "SUR", "GRD", "KNA", "TCA", 
                "ATG", "HTI", "MNE", "AUT", "HUN", "SVK", "STP", "VGB", "DOM", 
                "BLZ", "PRT", "HND", "COL", "CRI", "BRA", "NIC", "ALB", "EST", 
                "SDN", "LBN", "JOR", "LBY", "CYP", "QAT", "CHL", "LVA", "LTU", 
                "SYR", "MDA", "CIV", "TUN", "DZA", "FRO", "GRL", "URY", "IRL", 
                "COM", "TZA", "LBR", "CPV", "BHR", "TKM", "AZE", "KAZ", "SVN", 
                "GIB", "PRY", "CYM", "CUB", "JAM", "PRK", "MRT", "GNQ", "KEN", 
                "SRB", "PAK", "MSR", "MDV", "GUM", "COG", "GMB", "FLK", "ESH", 
                "SLE", "MDG", "ABW", "PER", "PYF", "NZL", "DMA", "BMU", "ERI", 
                "SLV", "COD", "MAC", "WSM", "FJI", "TON", "FSM", "TLS", "NCL", 
                "TUV", "GTM", "VUT", "NRU", "MNP", "PLW", "NIU", "COK", "SHN", 
                "WLF")

img_urls <- paste0(
  'https://cdn.rawgit.com/lipis/flag-icon-css/master/flags/4x3/',
  countries, '.svg'
)

speeches_tf_idf = readRDS(file = "https://github.com/bakered/GA24/raw/main/speeches_tf_idf.RDS")
#speeches_tf_idf <- read.csv(file = "r_helper_objects/speeches_tf_idf.csv")


# Define UI for app that draws a histogram ----
ui <- fluidPage(
  numericInput("n", "Sample count", 100),
  prettyCheckbox("pause", "Pause", FALSE),
  multiInput(
    inputId = "countries", 
    label = "Countries:",
    choices = NULL,
    choiceNames = lapply(seq_along(countries2), function(i) {
         tagList(
           tags$img(src = img_urls[i], width = 20, height = 15),
           countries2[i]
         )}),
    choiceValues = countries2,
    selected = c("BRA", "IND", "RUS", "ZAF", "UKR"), 
    width = "350px"
    ),
  plotOutput("plot") #, width=1100)
)


server <- function(input, output, session) {
  output$plot <- renderPlot({
    speeches_tf_idf %>%
      filter(ISO3 %in% input$countries) %>% 
      group_by(ISO3) %>%
      slice_max(tf_idf, n = 15) %>%
      ungroup() %>%
      ggplot(aes(tf_idf, fct_reorder(word, tf_idf), fill = ISO3)) +
      geom_col(show.legend = FALSE) +
      facet_wrap(~ISO3, ncol = 4, scales = "free") +
      labs(x = "tf-idf", y = NULL)
    }, res=140)
}

# Create Shiny app ----
shinyApp(ui = ui, server = server)
```

```{shinylive-python}

#| standalone: true
#| viewerHeight: 800

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from shiny import App, ui, render, reactive
from shinywidgets import output_widget, register_widget, render_widget
import numpy as np

# Mock data to simulate speeches_tf_idf
# In practice, you would load this from a CSV or dataset
data = {
    "ISO3": np.random.choice(["BRA", "IND", "RUS", "ZAF", "UKR"], 100),
    "tf_idf": np.random.rand(100),
    "word": np.random.choice([f"word_{i}" for i in range(1, 21)], 100)
}
speeches_tf_idf = pd.DataFrame(data)

# Read the CSV file into a DataFrame
speeches_tf_idf = pd.read_csv("r_helper_objects/speeches_tf_idf.csv")

# List of countries and corresponding flag URLs
countries2 = ["BRA", "IND", "RUS", "ZAF", "UKR"]
img_urls = [f"https://cdn.rawgit.com/lipis/flag-icon-css/master/flags/4x3/{c.lower()}.svg" for c in countries2]

# Define UI for the app
app_ui = ui.page_fluid(
    ui.input_numeric("n", "Sample count", 100),
    ui.input_checkbox("pause", "Pause", False),
    ui.input_selectize(
        "countries", "Countries:", 
        choices=countries2, 
        selected=["BRA", "IND", "RUS", "ZAF", "UKR"], 
        multiple=True
    ),
    ui.output_plot("plot")
)

# Server logic
def server(input, output, session):
    
    @output
    @render.plot
    def plot():
        selected_countries = input.countries()
        filtered_data = speeches_tf_idf[speeches_tf_idf["ISO3"].isin(selected_countries)]
        top_words = filtered_data.groupby('ISO3').apply(lambda x: x.nlargest(15, 'tf_idf')).reset_index(drop=True)
        
        # Plot using seaborn
        plt.figure(figsize=(10, 8))
        sns.barplot(
            data=top_words, 
            x='tf_idf', 
            y='word', 
            hue='ISO3', 
            dodge=False
        )
        plt.title('TF-IDF of Words by Country')
        plt.xlabel('tf-idf')
        plt.ylabel('Word')
        plt.legend(title="Country")
        plt.tight_layout()

# Create the app
app = App(app_ui, server)

```


# UNITAS Insights

## todo

- [ ]  short summary of each speech by UNITAS
- [ ]  make it do first priority sheet first, also keep all source chunks
- [ ]  run it on vm
- [ ]  include summary of speech in embedded app

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width = 6, fig.height = 3.5)
library(htmlwidgets)
library(webshot)
source("UNITAS_graphs1.R")
theme_set(
  theme_minimal(base_family = "Helvetica") +
  theme(
    text = element_text(family = "Helvetica")  # Set the font family
  )
)
```

## Intro

The following is a partial analysis of `r num_speeches`/~194 GA speeches from 2024 using UNITAS LLM.

### Process:

-   takes a transcript of speech
-   takes a list of questions written in UNITAS_questions.csv
-   feeds UNITAS LLM a question one by one
-   records the answers in csv_outputs/UNITAS_answers.csv
-   if UNITAS produces a non-standard answer, then it records 'LLM Fail'

### How long does it take?

-   roughly one minute per question per country
-   I did 30 questions, therefore half hour per country
-   adding a question adds 194 minutes to the time \~3 hours

\pagebreak

## Questions

### name the 5 key topics of the speech

Prompt: Name the 5 key topics or themes of the speech transcript. Give the answer in the form of a comma separated list (topic1, topic2, topic3, topic4, topic5) where each topic is a single word or two words. If there are fewer than five topics, leave the space blank. Only reply with the list, do not write anything else.

```{r, echo=FALSE}
word_cloud1 = wordcloud2(words1, size=0.8, color=rep_len(c("grey","skyblue"), nrow(words1)), minRotation = -pi/6, maxRotation = -pi/6, rotateRatio = 1)
saveWidget(word_cloud1, "tmp.html", selfcontained = F)
webshot("tmp.html", "word_cloud1.png", delay = 5)
```

\pagebreak

If we ask UNITAS the same question again, it comes up with similar answers:

```{r, echo=FALSE}
word_cloud2 = wordcloud2(words2, size =0.8, color=rep_len(c("grey","skyblue"), nrow(words2)))
saveWidget(word_cloud2, "tmp.html", selfcontained = F)
webshot("tmp.html", "word_cloud2.png", delay = 5)
```

\pagebreak

This is the same data in a plot. First time we ask the question...

```{r, echo=FALSE}
lollipop_plot("keyTopics5")
```

and second time we ask the question:

```{r, echo=FALSE}
lollipop_plot("keyTopics3")
```

\pagebreak

### Which countries or regions does the speech mention?

Prompt: Which countries or regions does the speech transcript mention? Give a reply in the form of a comma separated list with the most mentioned country or region first. Do not write anything else.

```{r, echo=FALSE}
lollipop_plot("countries")
```

\pagebreak

### What is the general sentiment of the speech?

Prompt: What is the general sentiment of the speech?IGive a one or two word reply from one of the following five options: 'negative', 'slightly negative', 'neutral', 'slightly positive' or 'positive'. Do not write anything else.

```{r, echo=FALSE}
 bar_plot("sentiment")
```

```{r, echo=FALSE}
 bar_plot("sentiment", group="unctad_development_status")
```

\pagebreak

### What issue or concern is the speech most worried about?

Prompt: What issue or concern does the speech transcript express the most worry or concern about? Give a reply in one or two words. Do not write anything else.

```{r, echo=FALSE}
 lollipop_plot("concerns")
```

\pagebreak

### Which crises does the speech mention?

Prompt: Which crises does the speech transcript mention? Give a reply in the form of a comma-separated list with the most mentioned crisis first. Do not write anything else.

```{r, echo=FALSE}
  lollipop_plot("crises")
```

\pagebreak

### Does the speech mention issues related to food supply?

Prompt: Does the speech mention issues related to food supply? Give a reply from one of the following options: 'not at all', 'briefly', 'a lot'. Do not write anything else.

```{r, echo=FALSE}
  bar_plot("crisisFood")
```

```{r, echo=FALSE}
  bar_plot("crisisFood", group="unctad_development_status")
```

\pagebreak

### Does the speech mention issues related to finance?

Prompt: Does the speech mention issues related to finance? Give a reply from one of the following options: 'not at all', 'briefly', 'a lot'. Do not write anything else.

```{r, echo=FALSE}
bar_plot("crisisFinance")
```

```{r, echo=FALSE}
  bar_plot("crisisFinance", group="unctad_development_status")
```

\pagebreak

### Does the speech mention issues related to energy supply?

Prompt: Does the speech mention issues related to energy supply? Give a reply from one of the following options: 'not at all', 'briefly', 'a lot'. Do not write anything else.

```{r, echo=FALSE}
 bar_plot("crisisEnergy")

```

```{r, echo=FALSE}

bar_plot("crisisEnergy", group="unctad_development_status")
```

\pagebreak

### Which other nations or international bodies does the speech criticize?

Prompt: Which nations or international bodies does the speech transcript criticize? Give a reply in the form of a comma-separated list with the most criticized nation or body first. Do not write anything else.

```{r, echo=FALSE}
  lollipop_plot("criticise")
```

\pagebreak

### Which other nations or international bodies does the speech praise?

Prompt: Which nations or international bodies does the speech transcript praise? Give a reply in the form of a comma-separated list with the most praised nation or body first. Do not write anything else.

```{r, echo=FALSE}
  lollipop_plot("praise")
```

\pagebreak

### Does the speech mention war or armed conflict?

Prompt: Does the speech mention war or armed conflict? Give a reply from one of the following options: 'not at all', 'briefly', 'a lot'. Do not write anything else.

```{r, echo=FALSE}
  bar_plot("conflict")
```

```{r, echo=FALSE}
bar_plot("conflict", group="unctad_development_status")
```

\pagebreak

### Does the speech mention the Israel Palestine conflict?

Prompt: Does the speech transcript mention the Israel Palestine conflict or peace process? Give a one word reply. Answer either 'Yes' or 'No'.

```{r, echo=FALSE}
bar_plot("israelPalestineConflict")
```

```{r, echo=FALSE}
bar_plot("israelPalestineConflict", group="unctad_development_status")
```

\pagebreak

### Is the speech more supportive of Israel or Palestine?

Prompt: Is the speech transcript more supportive of Israel or Palestine? Give a reply from one of the following four options: 'Israel', 'Palestine', 'neither', 'both'. If the speech does not mention Israel or Palestine, answer 'neither'. Do not write anything else.

```{r, echo=FALSE}
bar_plot("proIsraelPalestine")
```

```{r, echo=FALSE}
bar_plot("proIsraelPalestine", group="unctad_development_status")
```

\pagebreak

### Does the speech mention the conflict in Ukraine?

Prompt: Does the speech mention the conflict in Ukraine? Give a reply from one of the following options: 'not at all', 'briefly', 'a lot'. Do not write anything else.

```{r, echo=FALSE}
bar_plot("ukraineConflict")
```

```{r, echo=FALSE}
bar_plot("ukraineConflict", group="unctad_development_status")
```

\pagebreak

### Is the speech more supportive of Ukraine or Russia?

Prompt: Is the speech more supportive of Ukraine or Russia? Give a reply from one of the following options: 'Ukraine', 'Russia', 'neutral'. Do not write anything else.

```{r, echo=FALSE}
bar_plot("proUkraineConflict")
```

```{r, echo=FALSE}
bar_plot("proUkraineConflict", group="unctad_development_status")
```

\pagebreak

### Does the speech mention global climate change?

Prompt: Does the speech mention global climate change? Give a reply from one of the following options: 'not at all', 'briefly', 'a lot'. Do not write anything else.

```{r, echo=FALSE}
bar_plot("climateChange")
```

```{r, echo=FALSE}
bar_plot("climateChange", group="unctad_development_status")
```

\pagebreak

### Does the speech express concern about global climate change?

Prompt: Does the speech express concern about global climate change? Does it think we need to do more to combat global climate change? Give a reply from one of the following options: 'says we need to do more', 'says we are doing enough', 'says we need to do less'. 'does not mention global climate change'. Do not write anything else.

```{r, echo=FALSE}
bar_plot("combatClimate")
```

```{r, echo=FALSE}
bar_plot("combatClimate", group="unctad_development_status")
```

\pagebreak

### Does the speech mention gender equality or protecting women's rights?

Prompt: Does the speech mention gender equality or protecting women's rights? Give a reply from one of the following options: 'not at all', 'briefly', 'a lot'. Do not write anything else.

```{r, echo=FALSE}
bar_plot("gender")
```

```{r, echo=FALSE}
bar_plot("gender", group="M.F")
```

\pagebreak

### Does the speech mention Sustainable Development Goals (SDGs)?

Prompt: Does the speech mention Sustainable Development Goals (SDGs)? Give a reply from one of the following options: 'not at all', 'briefly', 'a lot'. Do not write anything else.

```{r, echo=FALSE}
bar_plot("SDG")
```

```{r, echo=FALSE}
bar_plot("SDG", group="unctad_development_status")
```

\pagebreak

### Does the speech advocate for Human rights?

Prompt: Does the speech advocate for human rights? Give a reply from one of the following options: 'not at all', 'briefly', 'a lot'. Do not write anything else.

```{r, echo=FALSE}
bar_plot("humanRights")
```

```{r, echo=FALSE}
bar_plot("humanRights", group="unctad_development_status")
```

\pagebreak

### Does the speech emphasize the importance of international law, treaties, or agreements?

Prompt: Does the speech emphasize the importance of international law, treaties, or agreements? Give a reply from one of the following options: 'not at all', 'briefly', 'a lot'. Do not write anything else.

```{r, echo=FALSE}
bar_plot("internationalLaw")
```

```{r, echo=FALSE}
bar_plot("internationalLaw", group="unctad_development_status")
```

\pagebreak

### Does the speech mention debt relief?

Prompt: Does the speech mention debt relief? Give a reply from one of the following options: 'not at all', 'briefly', 'a lot'. Do not write anything else.

```{r, echo=FALSE}
bar_plot("debtRelief")

```

```{r, echo=FALSE}
bar_plot("debtRelief", group="unctad_development_status")

```

\pagebreak

### Which international alliances with specific countries or regions does the speech advocate strengthening?

Prompt: Which international alliances with specific countries or regions does the speech transcript advocate strengthening? Give a reply in the form of a comma-separated list with the most emphasized alliance or region first. Do not write anything else.

```{r, echo=FALSE}
lollipop_plot("alliances")
```

\pagebreak

### Does the speech discuss migration, asylum, or refugee crises?

Prompt: Does the speech discuss migration, asylum, or refugee crises? Give a reply from one of the following options: 'not at all', 'briefly', 'a lot'. Do not write anything else.

```{r, echo=FALSE}
bar_plot("migration")
```

```{r, echo=FALSE}
bar_plot("migration", group="unctad_development_status")

```

\pagebreak

### Which global health issues like pandemics, healthcare access, or diseases does the speech mention?

Prompt: Which global health issues like pandemics, healthcare access, or diseases does the speech transcript mention? Give a reply in the form of a comma-separated list with the most mentioned issue first. Do not write anything else.

```{r, echo=FALSE}
lollipop_plot("health")
```

\pagebreak

### Does the speech mention nuclear weapons, disarmament, or non-proliferation?

Prompt: Does the speech mention nuclear weapons, disarmament, or non-proliferation? Give a reply from one of the following options: 'not at all', 'briefly', 'a lot'. Do not write anything else.

```{r, echo=FALSE}
bar_plot("nuclear")
```

```{r, echo=FALSE}
bar_plot("nuclear", group="unctad_development_status")
```

\pagebreak

### Does the speech mention global terrorism, radicalization, or counterterrorism strategies?

Prompt: Does the speech mention global terrorism, radicalization, or counterterrorism strategies? Give a reply from one of the following options: 'not at all', 'briefly', 'a lot'. Do not write anything else.

```{r, echo=FALSE}
bar_plot("terrorism")

```

```{r, echo=FALSE}
bar_plot("terrorism", group="unctad_development_status")

```

\pagebreak

### Which historical events does the speech mention?

Prompt: Which historical events does the speech transcript mention? Give a reply in the form of a comma-separated list with the most mentioned event first. Do not write anything else.

```{r, echo=FALSE}
  lollipop_plot("historicalEvents")
```

\pagebreak

### Which international sanctions or trade embargoes does the speech support?

Prompt: Which international sanctions or trade embargoes does the speech support? Give a reply in the form of a comma-separated list with the most supported sanction or embargo first. Do not write anything else.

no graph

```{r, echo=FALSE}

```

\pagebreak

### Which international sanctions or trade embargoes does the speech criticize?

Prompt: Which international sanctions or trade embargoes does the speech criticize? Give a reply in the form of a comma-separated list with the most criticized sanction or embargo first. Do not write anything else.

no graph